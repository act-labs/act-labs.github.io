(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{709:function(e,a,n){"use strict";n.r(a);var t=n(0),r=n.n(t),o=n(14),s=n.n(o),i=n(15),c=n.n(i),l=n(1),m=function(e){function a(a){var n;return(n=e.call(this,a)||this).layout=null,n}return c()(a,e),a.prototype.render=function(){var e=this.props,a=e.components;s()(e,["components"]);return r.a.createElement(l.MDXTag,{name:"wrapper",components:a},r.a.createElement(l.MDXTag,{name:"p",components:a},"Despite popularity of serverless and Kubernetes, ordinary virtual machines could be handy for development, bulky workloads, small applications, databases or inherently scalable applications like Kafka. Google provides API enabling developers to quickly spin up machines of many types, ranging from micro instances to multi-processor or GPU enabled boxes. Working with Google APIs directly could be quite cumbersome, but luckily there are tools which are able to do heavy lifting for us. Terraform is one of the most popular tools, allowing to treat infrastructure as a code, and thus providing a higher level of abstraction. Its declarative configuration syntax allows to describe desirable cloud infrastructure in a concise, human readable fashion. The tool is then able to create required cloud resources and saves the recent state of infrastructure (existing infrastructure could be imported as well). Later, upon request, Terraform is able to update the state of your cloud infrastructure smartly, or can destroy it completely. Lets look at how Terraform configuration may look like for GCP compute instances."),r.a.createElement(l.MDXTag,{name:"h2",components:a},"VPC"),r.a.createElement(l.MDXTag,{name:"p",components:a},"Before creating compute instances we may wish to create our private network. VPCs allow to divide cloud infrastructure into subnets and configure external access using firewall rules. Suppose we wish to create multiple web servers. Then VPC could be configured to allow SSH access, HTTP requests and pings:"),r.a.createElement(l.MDXTag,{name:"pre",components:a},r.a.createElement(l.MDXTag,{name:"code",components:a,parentName:"pre",props:{className:"language-sh"}},'// Create VPC\nresource "google_compute_network" "vpc" {\n name                    = "${var.project_name}-vpc"\n auto_create_subnetworks = false\n}\n\n// Create Subnet\nresource "google_compute_subnetwork" "app" {\n name          = "${var.project_name}-app-subnet"\n ip_cidr_range = var.subnet_cidr\n network       = "${var.project_name}-vpc"\n depends_on    = [google_compute_network.vpc]\n region        = var.region\n}\n\n// VPC firewall configuration\nresource "google_compute_firewall" "firewall" {\n  name    = "${var.project_name}-firewall"\n  network = google_compute_network.vpc.name\n\n  allow {\n    protocol = "icmp"\n  }\n\n  allow {\n    protocol = "tcp"\n    ports    = ["22"]\n  }\n\n  allow {\n    protocol = "tcp"\n    ports    = ["80", "8080", "1000-9000"]\n  }\n\n  source_tags = ["web"]\n\n  source_ranges = ["0.0.0.0/0"]\n}\n')),r.a.createElement(l.MDXTag,{name:"p",components:a},"Terraform, has the notion of variables, which are usually defined in a separate ",r.a.createElement(l.MDXTag,{name:"inlineCode",components:a,parentName:"p"},"variables.tf")," file. Default variable values could be overridden using JSON files, environment variables or during module invocation. Variables make configuration flexible and reusable."),r.a.createElement(l.MDXTag,{name:"h2",components:a},"Google compute instances"),r.a.createElement(l.MDXTag,{name:"p",components:a},"Although Terraform configuration is declarative and human readable, it has quite powerful control flow constructs, for example, supporting arrays and iterations. Thanks to this, multiple web servers could be created (see ",r.a.createElement(l.MDXTag,{name:"inlineCode",components:a,parentName:"p"},"count")," property assignment):"),r.a.createElement(l.MDXTag,{name:"pre",components:a},r.a.createElement(l.MDXTag,{name:"code",components:a,parentName:"pre",props:{className:"language-sh"}},'resource "google_compute_instance" "webservers" {\n  count                     = length(var.webservers)\n  name                      = "${var.project_name}-web-${count.index}"\n  machine_type              = var.webservers[count.index].type\n  zone                      = var.zone\n\n  tags = ["http-server", "https-server", var.webservers[count.index].name]\n\n  service_account {\n    scopes = var.scopes_default_web\n  }\n\n  metadata_startup_script = "sudo apt-get update; sudo apt-get install -yq build-essential python-pip rsync; pip install flask"\n\n  network_interface {\n    subnetwork = google_compute_subnetwork.app.self_link\n    access_config {\n      // Ephemeral IP\n    }\n  }\n\n  boot_disk {\n    initialize_params {\n      image = var.webservers[count.index].image\n    }\n  }\n}\n')),r.a.createElement(l.MDXTag,{name:"p",components:a},"Here variable ",r.a.createElement(l.MDXTag,{name:"inlineCode",components:a,parentName:"p"},"webservers")," (referenced as ",r.a.createElement(l.MDXTag,{name:"inlineCode",components:a,parentName:"p"},"var.webservers"),") is an array of objects containing server parameters. Providing such an array, one may create as many servers as he wish (even none at all)."),r.a.createElement(l.MDXTag,{name:"p",components:a},"Using ",r.a.createElement(l.MDXTag,{name:"inlineCode",components:a,parentName:"p"},"metadata_startup_script")," argument, multiple python packages could be installed. A ",r.a.createElement(l.MDXTag,{name:"inlineCode",components:a,parentName:"p"},"metadata_startup_script")," (as any Terraform string type argument) could be a multiline string, so, using this method, a fully functional server could be provisioned using, for example, some docker containers. Or we may setup compute instances manually or using tools like Ansible."),r.a.createElement(l.MDXTag,{name:"p",components:a},"Finally to get access to the running servers, we need their IP addresses. To obtain them define outputs:"),r.a.createElement(l.MDXTag,{name:"pre",components:a},r.a.createElement(l.MDXTag,{name:"code",components:a,parentName:"pre",props:{className:"language-sh"}},'output "webserver_ip_addresses" {\n value = {\n      for webserver in google_compute_instance.webservers:\n        webserver.instance_id => webserver.network_interface.0.access_config.0.nat_ip\n   }\n}\n')),r.a.createElement(l.MDXTag,{name:"h2",components:a},"SSH keys"),r.a.createElement(l.MDXTag,{name:"p",components:a},"To simplify maintenance, ssh keys could be generated for later upload to GCP:"),r.a.createElement(l.MDXTag,{name:"pre",components:a},r.a.createElement(l.MDXTag,{name:"code",components:a,parentName:"pre",props:{className:"language-sh"}},"# first, generate ssh keys\nssh-keygen -t rsa -f ssh-key -C admin\n")),r.a.createElement(l.MDXTag,{name:"p",components:a},"Using Terraform ",r.a.createElement(l.MDXTag,{name:"inlineCode",components:a,parentName:"p"},"file")," function, generated file now could be uploaded to GCP (for flexibility, location of the public key file is defined in ",r.a.createElement(l.MDXTag,{name:"inlineCode",components:a,parentName:"p"},"ssh_pub_key_file")," variable):"),r.a.createElement(l.MDXTag,{name:"pre",components:a},r.a.createElement(l.MDXTag,{name:"code",components:a,parentName:"pre",props:{className:"language-sh"}},'resource "google_compute_project_metadata_item" "ssh-keys" {\n  project     = var.gcp_project\n  key   = "ssh-keys"\n  value = "${var.ssh_user}:${file(var.ssh_pub_key_file)}"\n}\n')),r.a.createElement(l.MDXTag,{name:"p",components:a},"When configuration is ready, it is possible to verify, apply or preview it using commands like ",r.a.createElement(l.MDXTag,{name:"inlineCode",components:a,parentName:"p"},"terraform verify"),", ",r.a.createElement(l.MDXTag,{name:"inlineCode",components:a,parentName:"p"},"terraform apply"),", ",r.a.createElement(l.MDXTag,{name:"inlineCode",components:a,parentName:"p"},"terraform plan"),". After infrastructure is finally created, one may test correctness of the setup manually, using, for example, simple Hello World python application:"),r.a.createElement(l.MDXTag,{name:"pre",components:a},r.a.createElement(l.MDXTag,{name:"code",components:a,parentName:"pre",props:{className:"language-python"}},"from flask import Flask\napp = Flask(__name__)\n\n@app.route('/')\ndef hello_cloud():\n   return 'Hello GCP!'\n\napp.run(host='0.0.0.0')\n")),r.a.createElement(l.MDXTag,{name:"p",components:a},"To test our setup, login to server, save the above snippet into ",r.a.createElement(l.MDXTag,{name:"inlineCode",components:a,parentName:"p"},"app.py")," file, start web application, and finally test it using IP address of the server from Terraform output:"),r.a.createElement(l.MDXTag,{name:"pre",components:a},r.a.createElement(l.MDXTag,{name:"code",components:a,parentName:"pre",props:{className:"language-sh"}},"# login:\nssh -i ssh-key admin@XX.XXX.249.234\n\n# save and start simple Flask server:\npython app.py\n\n# test accessibility:\ncurl http://XX.XXX.249.234:5000\n")),r.a.createElement(l.MDXTag,{name:"h2",components:a},"Source code"),r.a.createElement(l.MDXTag,{name:"p",components:a},"Thanks to Terraform, in a matter of seconds, one may easily spin up new virtual machines (",r.a.createElement(l.MDXTag,{name:"inlineCode",components:a,parentName:"p"},"terraform apply"),") or destroy unused cloud resources (",r.a.createElement(l.MDXTag,{name:"inlineCode",components:a,parentName:"p"},"terraform destroy"),"). Take the ",r.a.createElement(l.MDXTag,{name:"a",components:a,parentName:"p",props:{href:"https://github.com/act-labs/gcp-terraform",title:"Terraform configuration to create Google VPC, compute instances and SSH keys"}},"code")," on Github and give it a spin."))},a}(r.a.Component),p=n(758);function u(e){return r.a.createElement(p.a,e,r.a.createElement(m,e))}n.d(a,"default",function(){return u})},738:function(e,a,n){"use strict";n(46);var t=n(739),r=n(0),o=n.n(r),s=n(2),i=n.n(s),c=n(749),l=n.n(c),m=n(34);function p(e){var a=e.description,n=e.lang,r=e.meta,s=e.keywords,i=e.title;return o.a.createElement(m.b,{query:u,render:function(e){return"string"==typeof s&&(s=s.split(",").map(function(e){return e.trim()})),a=a||e.site.siteMetadata.description,o.a.createElement(l.a,{htmlAttributes:{lang:n},title:i,titleTemplate:"%s | "+e.site.siteMetadata.project,meta:[{name:"description",content:a},{property:"og:title",content:i},{property:"og:description",content:a},{property:"og:type",content:"website"},{name:"twitter:card",content:"summary"},{name:"twitter:creator",content:e.site.siteMetadata.author},{name:"twitter:title",content:i},{name:"twitter:description",content:a}].concat(s?{name:"keywords",content:s.join(", ")}:[]).concat(r)})},data:t})}p.defaultProps={lang:"en",meta:[],keywords:null},p.propTypes={description:i.a.string,lang:i.a.string,meta:i.a.array,keywords:i.a.oneOfType([i.a.string,i.a.arrayOf(i.a.string)]),title:i.a.string.isRequired},a.a=p;var u="304502870"},739:function(e){e.exports={data:{site:{siteMetadata:{project:"ACT blog",description:"React, Ant Design, Gatsby, GraphQl, and other web technologies",author:"Act Labs"}}}}},740:function(e,a,n){"use strict";n.d(a,"a",function(){return l});n(352);var t=n(741),r=n(0),o=n.n(r),s=n(34),i=n(231),c=n.n(i);function l(){return o.a.createElement(s.b,{query:"2369744027",render:function(e){return o.a.createElement(c.a,{fixed:e.logo.childImageSharp.fixed,style:{float:"left"}})},data:t})}},741:function(e){e.exports={data:{logo:{childImageSharp:{fixed:{base64:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAAAsSAAALEgHS3X78AAAGG0lEQVQ4y32VCVBTVxSGX2FcaqfTmWptx7aOndFKXZFqy9iOVqyOLcqMxaVW6lKXikowLAKyFDCERRN2whJICEkIMQEUhEgkZYnKmgQiWwKyOK4oQRah5OWevndprW1t78ybc+8753757zn3vBDEP4auuYEAgBfr9MyEZS/7I/1+4jA997vQ87AAL3vL4wH8XqPREGNjY8QrByf0mB1tuWGertGM78115al7H+jyIpsr03PKeT5QyvHaQ/uFx+bjuPq6m3hfY1PTv2EDD4aIW/mncaBaxsq/X5cGQx1iyIk/BRO9KsgWxEBApNfUaJfyAB1jvHF5dvJBZxyvio/6O6y54SZRXpyH51uOX5plqkltH+/Kg+HW7KkZQcnWrCq1VaoqJl2z8+BWfsBEena2M5We1+n4s5sc7F55XKWU/xpt3Y4nvtHfkDvwsDkTdJfDbeniWNA2q5BWkYoaruWQQz0VoFHJPi9KCV9VEO9/cFoha+4LUEVSMlFOWfnVeAyMOeb6YVdbhXnSooe7hiIbOVAJ5KMmuHNbbRsf1MPkU+PTc1qYWRrD+KogwKMl3Y95Uuh7MhDDqpSFhO8fYP6qWTNomxX8daTk9D7oV8usAAMIWdoAWW4jeN5JjvfUQoNKhlWBZXCOctdmXYTHLh/q+PYYItu9D1vxOwtwHgrd92wpWOvcd+29RdD3wWKbMSsS2awmQIMGZB1tI/uviaFszbrMP0+nPuQmbjqw2wEvzCYTtsINmzBMtG//l4WOa+HykuVQ5rOfNO/YCl3zFqI+eSoA2Qu2RzpEKQYdNxwS5i3Cd5Tr8+OFTNZxY9H1q29hmCQm7kUuxWvW6uqXrYba1U5T5uokuNuei2qZP6C0Q9th4E41gmdtCEbaydF7DcD1Z7jSe6IDjgRUCM+CNCPEg3g0MkKovt2B1ZXu2rve4LgOOj9xtN102YDu1PHQE302uiwPA37EQejUSAF+6wbroJ7KpQkMtdI+bXGsQhB1dFAQcQhy+Ky104VYsBAnU+ay1btwxUrIXbTUWrrdBYZMYqQriYG8VAaSntgJgzVFFNCMyCcGgJEONNRXA4MtfNDmBwM/+LAKwx6PjhKZb7+LgQWO6zOFmxxA7rDYqnLbinoa09HD5izQKsORghcIk4MUaNiIbEOtCIZvo+eP9KCvTOsrE4SICtgMHgY+sFgICUFMV3f1p4WdTk7QsWSFtdJ9G2rUJqGuqkTorU1CPQZK3VgX2J62gM1ipK6R0QrkHdDVlZ2m98rjfIVydbM9Bha/vwgrvPTFBm4rVZD6xcsnK1w3k7rzJ2w1To7QWBKHSEsroCEjUOrohwZOAeqDB91aDk5XnF+Wgn3yTayyZMdO3B1Kpu9HmlVO450r14DeYSW0rFgN7dmBNku3nIJh0F8WK+yGfsN088vjmAlUGzoQsnwRweN424t2Os+kHWXuu13L1zkbm1Z9ptRLI0zDvVJ4qMuxkU8NtCo6f9S8hbo+HSSM6qHt19Qyel9+tNd5SazfNiKa+O9xS8VpHGsXwb2mDHLiXo0NRjopSDvQV2bqSYt1sreQAqZosMKL/p75bK/DeCMvjukhTDjDy4n3DVBksNZwAv3m3iiM5bVXcuGxIcd2vynDNtQmARhtg/GHumGz7spwXz0fJs15YNJmVdCM4nj/bbJYZjDB5/ixy4QBUCk5B1WyUOjQJFj76zOeTZol0FgaTR03ixzpEEFXTUqXukS0TaXWzi+XRrmZqhOhmfKXiyNKcFGiT6/IYzFSCCHnFAUKAWmy93BuvFe3iWq3CQqmr0hUChJ8iyqlIXCz6DxoFJwDL6dDnORTeV0SBJIU/wJ6fUWYME/CZqQTGXHebAHX+xKHHbT0THLrzGJR9MbiXNY3+IMRfyatRh4KAi6jml5PGC/aywVxuHii1JBd1QWhoOQHx7z4kWgml/i/IU1mKtTiYMhJDtuIcx3rbZ+ffRH7MiXX50iSGGOxQR6tvyTWzMYtfP5MFMEJ/M5OGOVux7vgb1ekkBFlkig7RbrftIpEH14q6wh4/nz0Y3odcvYU7qiUcA9sBYlBB5NYJ4PZ7Iv4fyUz5pzT7+jdwN4yQU6eAAAAAElFTkSuQmCC",width:50,height:60,src:"/static/a64620346ac3ce8d4580a3f07039fa3c/8469d/logo.png",srcSet:"/static/a64620346ac3ce8d4580a3f07039fa3c/8469d/logo.png 1x"}}}}}},742:function(e){e.exports={data:{config:{copyright:"Copyright © Act Labs",social:[{icon:"facebook",link:"https://www.facebook.com/ACT7LAB"},{icon:"github",link:"https://github.com/act-labs/gatsby-starter-act-blog"}]}}}},743:function(e){e.exports={data:{config:{nav:[{text:"home",slug:null},{text:"posts",slug:"/posts/"},{text:"snippets",slug:"/snippets/"}]}}}},744:function(e,a,n){"use strict";n(6);var t=n(138),r=(n(178),n(31)),o=n.n(r),s=(n(750),n(736),n(737)),i=n.n(s),c=n(742),l=n(0),m=n.n(l),p=n(34),u=i.a.Footer;function g(e){var a=e.social,n=e.copyright,r=a.map(function(e){var a=e.link,n=e.icon;return m.a.createElement(t.a,{key:n,to:a},m.a.createElement(o.a,{type:n,style:{fontSize:"24px",marginLeft:10,color:"rgba(0, 0, 0, 0.65)"}}))});return m.a.createElement(u,{style:{textAlign:"center"}},m.a.createElement("div",null,n,m.a.createElement("div",{style:{float:"right"}},r)))}function d(e){return e.social?m.a.createElement(g,e):m.a.createElement(p.b,{query:"2743462859",render:function(a){var n=a.config,t=n.social,r=n.copyright;return m.a.createElement(g,Object.assign({social:t,copyright:r},e))},data:c})}n(748);var f=n(747),h=n.n(f),y=n(740),v=n(743),b=i.a.Header;function w(e){var a=e.nav;return m.a.createElement(b,{className:"navigation-bar"},m.a.createElement(t.a,{to:"/"},m.a.createElement(y.a,null)),m.a.createElement(h.a,{theme:"dark",mode:"horizontal",defaultSelectedKeys:a.filter(function(e){return e.selected}).map(function(e){return e.text}),style:{lineHeight:"64px"}},a.map(function(e,a){var n=e.slug,r=e.text;return m.a.createElement(h.a.Item,{key:a},m.a.createElement(t.a,{to:n||"/"},r))})))}function E(e){return e.nav?m.a.createElement(w,e):m.a.createElement(p.b,{query:"1250442554",render:function(a){var n=a.config.nav;return m.a.createElement(w,Object.assign({nav:n},e))},data:v})}var T=n(738),k=n(14),M=n.n(k);n(671);n.d(a,"a",function(){return C});var X=i.a.Content,D=i.a.Sider;function A(e){var a=e.style,n=e.children,t=M()(e,["style","children"]);return m.a.createElement(X,Object.assign({style:Object.assign({padding:"5px 24px"},a)},t),n)}function C(e){var a=e.children,n=e.className,t=e.title,r=e.description,o=e.keywords,s=e.style,c=e.layout,l=Object.assign({},N,c),p=l.footer,u=l.fullHeight,g=Object.assign({},u?{height:"100%"}:null,s),f=(n?n+" ":"")+"page-layout";return m.a.createElement(i.a,{className:f,style:g},m.a.createElement(T.a,{title:t,keywords:o,description:r}),m.a.createElement(E,null),a,p?m.a.createElement(d,null):null)}var N={footer:!0};C.Panel=A,C.SideMenuPanel=function(e){var a=e.children,n=e.menu;return m.a.createElement(i.a,{style:{padding:"1em 0",background:"#fff",minHeight:1e3}},m.a.createElement(D,{width:200},n),m.a.createElement(A,null,a))}},746:function(e,a,n){"use strict";n(6);var t=n(138),r=(n(46),n(0)),o=n.n(r),s=n(892),i=n(752),c=n(753),l=n(754),m=n(755),p=n(756),u=n(757);s.a.registerLanguage("javascript",i.a),s.a.registerLanguage("sh",c.a),s.a.registerLanguage("markdown",l.a),s.a.registerLanguage("yaml",m.a),s.a.registerLanguage("dockerfile",p.a);var g=n(1);n.d(a,"a",function(){return f});var d={components:{code:function(e){var a="bash";if(e.className){var n=e.className.split("-");n.length>1&&(a=n[1])}return o.a.createElement(s.a,{language:a,style:u.github},e.children)},a:t.a}};function f(e){var a=Object.assign({},d,e),n=a.components,t=a.children;return o.a.createElement(g.MDXProvider,{components:n},t)}},758:function(e,a,n){"use strict";n.d(a,"a",function(){return c});var t=n(746),r=(n(6),n(744)),o=n(0),s=n.n(o),i=(n(672),r.a.Panel);function c(e){var a=e.children,n=e.pageContext,o=Object.assign({frontmatter:{}},n),c=Object.assign({},{layout:o.layout},o.frontmatter);return s.a.createElement(r.a,c,s.a.createElement(i,{style:{paddingTop:"1em"}},c.title?s.a.createElement("h1",null,c.title):null,s.a.createElement(t.a,null,a)))}}}]);
//# sourceMappingURL=component---src-generated-posts-gcp-terraform-js-637432f6e6cc7659fad1.js.map