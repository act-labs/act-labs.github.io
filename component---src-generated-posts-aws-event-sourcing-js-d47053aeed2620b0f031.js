(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{457:function(e,a,t){"use strict";t.r(a);var n=t(0),o=t.n(n),r=t(225),s=t(74),c=t(7),m=t.n(c),i=t(4),l=t.n(i),p=t(1),d=function(e){function a(a){var t;return(t=e.call(this,a)||this).layout=null,t}return l()(a,e),a.prototype.render=function(){var e=this.props,a=e.components;m()(e,["components"]);return o.a.createElement(p.MDXTag,{name:"wrapper",components:a},o.a.createElement(p.MDXTag,{name:"p",components:a},"Today bushiness environment is very dynamic. Quickly ",o.a.createElement(p.MDXTag,{name:"em",components:a,parentName:"p"},"shifting business requirements")," call for ",o.a.createElement(p.MDXTag,{name:"em",components:a,parentName:"p"},"Agile")," software development, modular architectures and flexibly to concentrate on the functionality of highest business priority. Growing demand for modularity popularized ",o.a.createElement(p.MDXTag,{name:"em",components:a,parentName:"p"},"microservices"),", often implemented using ",o.a.createElement(p.MDXTag,{name:"em",components:a,parentName:"p"},"event sourcing")," and ",o.a.createElement(p.MDXTag,{name:"em",components:a,parentName:"p"},"CQRS")," patterns. Though special frameworks and tools like Apache Kafka could be helpful, essentially event sourcing is quite a simple concept and could be implemented just using, for example, AWS lambdas and DynamoDB. "),o.a.createElement(p.MDXTag,{name:"p",components:a},"The central idea of event sourcing is the notion of the ",o.a.createElement(p.MDXTag,{name:"em",components:a,parentName:"p"},"event log"),", which records all what happened in the system, and thus represents the application state. The events log is the elementary, immutable, unique source of truth, from which current application state and convenient data views could be always unambiguously reconstructed. This makes application design more logical, and its constituent parts, communicating only through events, better decoupled."),o.a.createElement(p.MDXTag,{name:"p",components:a},"Lets consider how such system may look like in practice. We may construe our application as a documents processor, where every document belongs to some ",o.a.createElement(p.MDXTag,{name:"em",components:a,parentName:"p"},"owner")," - a microservice with ",o.a.createElement(p.MDXTag,{name:"em",components:a,parentName:"p"},"exclusive rights to modify"),' its documents according to some business logic. Each microservice receives commands from users and other microservices and, in response, when necessary, generates updates or "events", stored in immutable event logs.'),o.a.createElement(s.a,null),o.a.createElement(r.a,{more:"/snippets/serverless/dynamodb-streams-configuration/",title:"DynamoDB streams configuration"},o.a.createElement(p.MDXTag,{name:"p",components:a},"To configure DynamoDB stream add"),o.a.createElement(p.MDXTag,{name:"pre",components:a},o.a.createElement(p.MDXTag,{name:"code",components:a,parentName:"pre",props:{className:"language-yaml"}},"    StreamSpecification:\n        StreamViewType: NEW_IMAGE\n")),o.a.createElement(p.MDXTag,{name:"p",components:a},"to table configuration")),o.a.createElement(p.MDXTag,{name:"p",components:a},"The key part of the architecture is the event log - an ",o.a.createElement(p.MDXTag,{name:"em",components:a,parentName:"p"},"ordered")," list of events processed by microservice. One way to achieve the ",o.a.createElement(p.MDXTag,{name:"em",components:a,parentName:"p"},"ordering")," in ",o.a.createElement(p.MDXTag,{name:"em",components:a,parentName:"p"},"AWS")," - is to use ",o.a.createElement(p.MDXTag,{name:"em",components:a,parentName:"p"},"DynamoDB streams"),". For this we create a ",o.a.createElement(p.MDXTag,{name:"em",components:a,parentName:"p"},"commands table"),", in which every part of the system may write commands (modification requests)."),o.a.createElement(p.MDXTag,{name:"pre",components:a},o.a.createElement(p.MDXTag,{name:"code",components:a,parentName:"pre",props:{className:"language-javascript"}},"module.exports.addCommand = async event => {\n  const data = JSON.parse(event.body);\n  if (typeof data.type !== 'string') {\n    console.error('Validation Failed')\n    return {\n      statusCode: 400,\n      headers: { 'Content-Type': 'text/plain' },\n      body: 'Couldn't add command.',\n    }\n  }\n\n  const params = {\n    TableName: process.env.COMMANDS_TABLE,\n    Key: {\n      microservice: data.type\n    },\n    UpdateExpression:\"set id = if_not_exists(id, :initial) + :inc, payload=:payload\",\n    ExpressionAttributeValues:{':inc': 1, ':initial' : 0, \":payload\": event.body}, \n    ReturnValues: \"NONE\"\n  }\n\n  // write the todo to the database\n  await dynamoDb.update(params).promise()\n\n  return {\n    statusCode: 200\n  }\n}\n")),o.a.createElement(r.a,{more:"/snippets/serverless/serverless-cli/",title:"Create new serverless project"},o.a.createElement(p.MDXTag,{name:"pre",components:a},o.a.createElement(p.MDXTag,{name:"code",components:a,parentName:"pre",props:{className:"language-sh"}},"serverless create --template  aws-nodejs --path example\n"))),o.a.createElement(p.MDXTag,{name:"p",components:a},"We use ",o.a.createElement(p.MDXTag,{name:"a",components:a,parentName:"p",props:{href:"https://serverless.com",title:"serverless framework to build and deploy AWS applications"}},"serverless framework")," to bundle our example AWS application. Writing updates to ",o.a.createElement(p.MDXTag,{name:"inlineCode",components:a,parentName:"p"},"COMMANDS_TABLE"),", we are able to produce a strictly ordered stream of commands. Leveraging AWS ",o.a.createElement(p.MDXTag,{name:"em",components:a,parentName:"p"},"update expressions")," we get growing id number (",o.a.createElement(p.MDXTag,{name:"inlineCode",components:a,parentName:"p"},"set id = if_not_exists(id, :initial) + :inc"),"). These updates later are processed by AWS lambda, subscribed to a DynamoDB stream:"),o.a.createElement(p.MDXTag,{name:"pre",components:a},o.a.createElement(p.MDXTag,{name:"code",components:a,parentName:"pre",props:{className:"language-javascript"}},'module.exports.example = async event => {\n  // process all commands  \n  for (const record of event.Records){\n    console.log(record.eventID)\n    console.log(record.eventName)\n    console.log(\'DynamoDB Record: %j\', record.dynamodb)\n\n    const sequenceNumber = record.dynamodb["NewImage"]["id"]["N"].padStart(10, "0")\n    const microservice = record.dynamodb["NewImage"]["microservice"]["S"]\n    const payload = record.dynamodb["NewImage"]["payload"]["S"]\n    const params = {\n      TableName: process.env.EVENTS_TABLE,\n      Item: {\n        microservice,\n        sequenceNumber,\n        payload\n      }\n    }\n    // some validation, business logic and event logging\n    await dynamoDb.put(params).promise()\n  }\n  return `Successfully processed ${event.Records.length} records.`;\n}\n')),o.a.createElement(p.MDXTag,{name:"p",components:a},"Microservice lambdas may do some command validation, data processing, execute some tasks, and update microservice state according to some business logic. And finally microservice should save ",o.a.createElement(p.MDXTag,{name:"em",components:a,parentName:"p"},"events")," (unless command has been already executed) and, possibly, using DynamoDB transactions, state snapshot. As a result requests to other microservices could be generated. Microservice lambda also could be responsible to generate data views\n(e.g. DynamoDB tables) to efficiently satisfy user queries. To make system even more modular, ",o.a.createElement(p.MDXTag,{name:"em",components:a,parentName:"p"},"SNS")," could be used to notify other subsystems/lambdas, devoted exclusively to data views generation."),o.a.createElement(p.MDXTag,{name:"p",components:a},"The ",o.a.createElement(p.MDXTag,{name:"em",components:a,parentName:"p"},"key")," schema in the ",o.a.createElement(p.MDXTag,{name:"em",components:a,parentName:"p"},"commands table"),' governs the system concurrency/scalability. All commands saved with the same key go to the same microservice. In our example we partition commands on microservice name (determined by "type" request attribute), so multiple microservices may reuse the same commands table and may live the same stream lambda. This could be adequate for small enterprise applications, but for more complex systems we may wish to partition commands based on some user/group/organization id. To further decouple system components, we may use different command tables and/or ',o.a.createElement(p.MDXTag,{name:"em",components:a,parentName:"p"},"SNS")," and ",o.a.createElement(p.MDXTag,{name:"em",components:a,parentName:"p"},"AWS Kinesis"),"."),o.a.createElement(p.MDXTag,{name:"p",components:a},"Using DynamoDB, we obtain ordered command stream, but by itself DynamoDB can't guarantee commands uniqueness (only once delivery). Thus, to assure idempontence, requests should contain some unique, growing id number, and microservice may wish to check/save the last user request ids. Along these lines, the typical request to our microservice may look like the following:"),o.a.createElement(p.MDXTag,{name:"pre",components:a},o.a.createElement(p.MDXTag,{name:"code",components:a,parentName:"pre",props:{className:"language-sh"}},'curl -XPOST https://XXXXX.execute-api.us-east-1.amazonaws.com/dev/command -d \'{"type":"microserviceName", "command":"commandName", "id":17, "timestamp":11178, "user":"userId"}\'\n')),o.a.createElement(p.MDXTag,{name:"p",components:a},"Event sourcing is an excellent paradigm when one strives to make modular, consistent, and error resilient system. That said, definitely not every application needs it. DynamoDB transactions and conditional updates provide powerful enough tools to handle simple concurrency/data dependencies. But in cases when one needs to handle complex transactional workflows, event sourcing is definitely the way to go. The complete source code of the example implementation of event sourcing using DynamoDB streams could be found on ",o.a.createElement(p.MDXTag,{name:"a",components:a,parentName:"p",props:{href:"https://github.com/act-labs/aws-event-sourcing-example",title:"AWS, simple event sourcing using DynamoDB streams"}},"Github"),". "))},a}(o.a.Component),u=t(492);function g(e){return o.a.createElement(u.a,e,o.a.createElement(d,e))}t.d(a,"default",function(){return g})},472:function(e,a,t){"use strict";t(57);var n=t(473),o=t(0),r=t.n(o),s=t(2),c=t.n(s),m=t(485),i=t.n(m),l=t(34);function p(e){var a=e.description,t=e.lang,o=e.meta,s=e.keywords,c=e.title;return r.a.createElement(l.b,{query:d,render:function(e){return"string"==typeof s&&(s=s.split(",").map(function(e){return e.trim()})),a=a||e.site.siteMetadata.description,r.a.createElement(i.a,{htmlAttributes:{lang:t},title:c,titleTemplate:"%s | "+e.site.siteMetadata.project,meta:[{name:"description",content:a},{property:"og:title",content:c},{property:"og:description",content:a},{property:"og:type",content:"website"},{name:"twitter:card",content:"summary"},{name:"twitter:creator",content:e.site.siteMetadata.author},{name:"twitter:title",content:c},{name:"twitter:description",content:a}].concat(s?{name:"keywords",content:s.join(", ")}:[]).concat(o)})},data:n})}p.defaultProps={lang:"en",meta:[],keywords:null},p.propTypes={description:c.a.string,lang:c.a.string,meta:c.a.array,keywords:c.a.oneOfType([c.a.string,c.a.arrayOf(c.a.string)]),title:c.a.string.isRequired},a.a=p;var d="304502870"},473:function(e){e.exports={data:{site:{siteMetadata:{project:"ACT blog",description:"React, Ant Design, Gatsby, GraphQl, and other web technologies",author:"Act Labs"}}}}},474:function(e,a,t){"use strict";t.d(a,"a",function(){return i});t(252);var n=t(475),o=t(0),r=t.n(o),s=t(34),c=t(158),m=t.n(c);function i(){return r.a.createElement(s.b,{query:"2369744027",render:function(e){return r.a.createElement(m.a,{fixed:e.logo.childImageSharp.fixed,style:{float:"left"}})},data:n})}},475:function(e){e.exports={data:{logo:{childImageSharp:{fixed:{base64:"data:image/png;base64,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",width:50,height:60,src:"/static/24243787906a1f19048f79ada574a876/8469d/logo.png",srcSet:"/static/24243787906a1f19048f79ada574a876/8469d/logo.png 1x,\n/static/24243787906a1f19048f79ada574a876/1d933/logo.png 1.5x,\n/static/24243787906a1f19048f79ada574a876/90789/logo.png 2x"}}}}}},476:function(e){e.exports={data:{config:{copyright:"Copyright © Act Labs",social:[{icon:"facebook",link:"https://www.facebook.com/ACT7LAB"},{icon:"github",link:"https://github.com/act-labs/gatsby-starter-act-blog"}]}}}},477:function(e){e.exports={data:{config:{nav:[{text:"home",slug:null},{text:"posts",slug:"/posts/"},{text:"snippets",slug:"/snippets/"}]}}}},478:function(e,a,t){"use strict";t(8);var n=t(93),o=(t(157),t(43)),r=t.n(o),s=(t(486),t(470),t(471)),c=t.n(s),m=t(476),i=t(0),l=t.n(i),p=t(34),d=c.a.Footer;function u(e){var a=e.social,t=e.copyright,o=a.map(function(e){var a=e.link,t=e.icon;return l.a.createElement(n.a,{key:t,to:a},l.a.createElement(r.a,{type:t,style:{fontSize:"24px",marginLeft:10,color:"rgba(0, 0, 0, 0.65)"}}))});return l.a.createElement(d,{style:{textAlign:"center"}},l.a.createElement("div",null,t,l.a.createElement("div",{style:{float:"right"}},o)))}function g(e){return e.social?l.a.createElement(u,e):l.a.createElement(p.b,{query:"2743462859",render:function(a){var t=a.config,n=t.social,o=t.copyright;return l.a.createElement(u,Object.assign({social:n,copyright:o},e))},data:m})}t(482);var y=t(479),h=t.n(y),f=t(474),v=t(477),b=c.a.Header;function E(e){var a=e.nav;return l.a.createElement(b,{className:"navigation-bar"},l.a.createElement(n.a,{to:"/"},l.a.createElement(f.a,null)),l.a.createElement(h.a,{theme:"dark",mode:"horizontal",defaultSelectedKeys:a.filter(function(e){return e.selected}).map(function(e){return e.text}),style:{lineHeight:"64px"}},a.map(function(e,a){var t=e.slug,o=e.text;return l.a.createElement(h.a.Item,{key:a},l.a.createElement(n.a,{to:t||"/"},o))})))}function D(e){return e.nav?l.a.createElement(E,e):l.a.createElement(p.b,{query:"1250442554",render:function(a){var t=a.config.nav;return l.a.createElement(E,Object.assign({nav:t},e))},data:v})}var T=t(472),w=t(7),N=t.n(w);t(420);t.d(a,"a",function(){return x});var M=c.a.Content,X=c.a.Sider;function A(e){var a=e.style,t=e.children,n=N()(e,["style","children"]);return l.a.createElement(M,Object.assign({style:Object.assign({padding:"5px 24px"},a)},n),t)}function x(e){var a=e.children,t=e.className,n=e.title,o=e.description,r=e.keywords,s=e.style,m=e.layout,i=Object.assign({},k,m),p=i.footer,d=i.fullHeight,u=Object.assign({},d?{height:"100%"}:null,s),y=(t?t+" ":"")+"page-layout";return l.a.createElement(c.a,{className:y,style:u},l.a.createElement(T.a,{title:n,keywords:r,description:o}),l.a.createElement(D,null),a,p?l.a.createElement(g,null):null)}var k={footer:!0};x.Panel=A,x.SideMenuPanel=function(e){var a=e.children,t=e.menu;return l.a.createElement(c.a,{style:{padding:"1em 0",background:"#fff",minHeight:1e3}},l.a.createElement(X,{width:200},t),l.a.createElement(A,null,a))}},481:function(e,a,t){"use strict";t(8);var n=t(93),o=(t(57),t(0)),r=t.n(o),s=t(659),c=t(487),m=t(488),i=t(489),l=t(490),p=t(491);s.a.registerLanguage("javascript",c.a),s.a.registerLanguage("sh",m.a),s.a.registerLanguage("markdown",i.a),s.a.registerLanguage("yaml",l.a);var d=t(1);t.d(a,"a",function(){return g});var u={components:{code:function(e){var a="bash";if(e.className){var t=e.className.split("-");t.length>1&&(a=t[1])}return r.a.createElement(s.a,{language:a,style:p.github},e.children)},a:n.a}};function g(e){var a=Object.assign({},u,e),t=a.components,n=a.children;return r.a.createElement(d.MDXProvider,{components:t},n)}},492:function(e,a,t){"use strict";t.d(a,"a",function(){return m});var n=t(481),o=(t(8),t(478)),r=t(0),s=t.n(r),c=(t(421),o.a.Panel);function m(e){var a=e.children,t=e.pageContext,r=Object.assign({frontmatter:{}},t),m=Object.assign({},{layout:r.layout},r.frontmatter);return s.a.createElement(o.a,m,s.a.createElement(c,{style:{paddingTop:"1em"}},m.title?s.a.createElement("h1",null,m.title):null,s.a.createElement(n.a,null,a)))}}}]);
//# sourceMappingURL=component---src-generated-posts-aws-event-sourcing-js-d47053aeed2620b0f031.js.map