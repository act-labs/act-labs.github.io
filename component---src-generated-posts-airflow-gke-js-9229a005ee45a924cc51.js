(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{718:function(e,t,a){"use strict";a.r(t);var n=a(0),o=a.n(n),r=a(14),s=a.n(r),i=a(15),c=a.n(i),l=a(1),m=function(e){function t(t){var a;return(a=e.call(this,t)||this).layout=null,a}return c()(t,e),t.prototype.render=function(){var e=this.props,t=e.components;s()(e,["components"]);return o.a.createElement(l.MDXTag,{name:"wrapper",components:t},o.a.createElement(l.MDXTag,{name:"p",components:t},"Apache Airflow is a well known workflow management platform. A few years ago Google announced Composer - a fully managed Kubernetes  installation of Apache Airflow, which is a great way to start automating your ETL, ML and DevOps chores using Python and Google Cloud platform. Still it could desirable to be able to install Airflow on GKE from scratch for variety of reasons: some may strive to gain more flexibility, or you could be running Airflow on premises and just look for ways to quickly spin up a similar cluster in cloud to process some extra bulky data. In this post I describe how to install and configure Apache Airflow components on GKE: Celery Executer, Redis and Cloud Sql. To deploy to Kubernetes I use a Helm chart. As Airflow is quite a complex platform, installation involves a lot of work on infrastructure: cluster should be created, Cloud Sql should be provisioned, SSD disk for Redis created, necessary Google APIs enabled, etc. To automate this chores I use Terraform."),o.a.createElement(l.MDXTag,{name:"h1",components:t},"Kubernetes deployment"),o.a.createElement(l.MDXTag,{name:"p",components:t},"To run Airflow, a few pods should be scheduled, most notably - scheduler, webserver, and worker pods. For this purpose, Stateful sets were used in combination with Headless Service for workers (notice clusterIP is None):"),o.a.createElement(l.MDXTag,{name:"pre",components:t},o.a.createElement(l.MDXTag,{name:"code",components:t,parentName:"pre",props:{className:"language-yaml"}},"apiVersion: v1\nkind: Service\nmetadata:\n  name: worker\nspec:\n  clusterIP: None\n  selector:\n    app: airflow\n    tier: worker\n  ports:\n    - protocol: TCP\n      port: 8793\n")),o.a.createElement(l.MDXTag,{name:"p",components:t},"Headless service could be used when cluster IP and load balancing between pods is not necessary (only the list of pod IPs is of the interest). In our case Headless Service just gives pods distinct networking identity (worker-0, worker-1, etc) and simplifies local logs access. Here no Persistent Volumes were created, but we can do it in case we want to save/archive logs (alternatively, Airflow could be configured to save logs in Google Cloud storage, Elastic Search, etc) or cache some static data."),o.a.createElement(l.MDXTag,{name:"p",components:t},"Using git sync to deliver Airflow DAGs is common practice, which to my taste looks like too much flexibility, opening the door to hard to debug inconsistencies. For this reason, DAGs, as well as additional Python packages are baked into Docker container image, which is built on top of ",o.a.createElement(l.MDXTag,{name:"a",components:t,parentName:"p",props:{href:"https://github.com/puckel/docker-airflow",title:"Airflow Docker image"}},"puckel/airflow")," image. To gain more flexibility the Docker image is built in two steps. First, an image containing additional packages and library code is built in ",o.a.createElement(l.MDXTag,{name:"inlineCode",components:t,parentName:"p"},"src")," directory (this image supposedly should not change too frequently).  Secondly, an image containing DAGs is built in root directory (this image may change more frequently as DAGs could be added, tweaked, or even generated on the fly)."),o.a.createElement(l.MDXTag,{name:"pre",components:t},o.a.createElement(l.MDXTag,{name:"code",components:t,parentName:"pre",props:{className:"language-sh"}},"# add libraries and third party packages\ncd src\ndocker build -t airflow-python .\n# add dags\ncd ..\ndocker build -t airflow-gke:latest .\n# push to Google Container repository\ndocker tag airflow-gke gcr.io/google_project_id/airflow-gke:latest\ndocker push gcr.io/google_project_id/airflow-gke\n# then, after cluster is created and configured, deploy complete application using Helm:\nhelm upgrade --install airflow . --set projectId=google_project_id\n")),o.a.createElement(l.MDXTag,{name:"h1",components:t},"Cloud SQL"),o.a.createElement(l.MDXTag,{name:"p",components:t},"For persistence, Airflow needs a database. In Google Cloud, a popular choice is a Cloud Sql - managed, highly available database instances from Google. To communicate with a Cloud Sql database from a cluster, a proxy pod, available as a ",o.a.createElement(l.MDXTag,{name:"inlineCode",components:t,parentName:"p"},"postgres")," service is used:"),o.a.createElement(l.MDXTag,{name:"pre",components:t},o.a.createElement(l.MDXTag,{name:"code",components:t,parentName:"pre",props:{className:"language-yaml"}},'kind: Deployment\napiVersion: apps/v1\nmetadata:\n  name: postgres\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      tier: postgres\n  template:\n    metadata:\n      labels:\n        app: airflow\n        tier: postgres\n    spec:\n      serviceAccountName: worker\n      restartPolicy: Always\n      containers:\n        - name: cloudsql-proxy\n          image: gcr.io/cloudsql-docker/gce-proxy:1.11\n          command: ["/cloud_sql_proxy", "-instances={{ template "dbinstances" . }}=tcp:0.0.0.0:5432",]\n          ports:\n            - name: postgres\n              containerPort: 5432\n')),o.a.createElement(l.MDXTag,{name:"p",components:t},"Cloud Sql proxy requires only DB instance reference (consisting of the DB instance name and availability zone) and the port to bind proxy to. Authentication is accomplished behind the scene using Workload Identity (through ",o.a.createElement(l.MDXTag,{name:"inlineCode",components:t,parentName:"p"},"worker")," Kubernetes service account), which is configured using Terraform scripts. To check configuration is correct you may run Google provided image with gcloud SDK and helpful utilities:"),o.a.createElement(l.MDXTag,{name:"pre",components:t},o.a.createElement(l.MDXTag,{name:"code",components:t,parentName:"pre",props:{className:"language-sh"}},"kubectl run -it   --image google/cloud-sdk:slim   --serviceaccount worker   --namespace default   workload-identity-test\n# upon successful login\ngcloud auth list\n")),o.a.createElement(l.MDXTag,{name:"p",components:t},"If the service accounts are correctly configured, the Google service account email address is listed as the active (and only) identity. In case of any errors, for troubleshooting, one may check pod logs (",o.a.createElement(l.MDXTag,{name:"inlineCode",components:t,parentName:"p"},"kubectl logs -l name=airflow"),") for authentication and other errors."),o.a.createElement(l.MDXTag,{name:"h1",components:t},"Create and configure cluster using Terraform"),o.a.createElement(l.MDXTag,{name:"p",components:t},"Before our application could be deployed to Kubernetes we actually need to create cluster and other required resources. The process involves a lot of tedious manual operations and thus is a good candidate for automation using Terraform."),o.a.createElement(l.MDXTag,{name:"p",components:t},"To use Terraform, first install it and create a new project and Google service account (Owner) from Google Cloud Console, downloading a key file. Next install and authenticate ",o.a.createElement(l.MDXTag,{name:"inlineCode",components:t,parentName:"p"},"gcloud")," SDK:"),o.a.createElement(l.MDXTag,{name:"pre",components:t},o.a.createElement(l.MDXTag,{name:"code",components:t,parentName:"pre",props:{className:"language-sh"}},"# authenticate using service-account key file\ngcloud auth activate-service-account --key-file=/auth/cloud-test-robot.json\n")),o.a.createElement(l.MDXTag,{name:"p",components:t},"GKE cluster itself is created in two steps. First we create infrastructure (cluster, Cloud Sql, SSD disk) using ",o.a.createElement(l.MDXTag,{name:"inlineCode",components:t,parentName:"p"},"infrastructure.tf")," file in the root directory. Just run usual terraform init and apply commands:"),o.a.createElement(l.MDXTag,{name:"pre",components:t},o.a.createElement(l.MDXTag,{name:"code",components:t,parentName:"pre",props:{className:"language-sh"}},"terraform init\nterraform apply\n")),o.a.createElement(l.MDXTag,{name:"p",components:t},"When infrastructure is ready, one may create and configure ",o.a.createElement(l.MDXTag,{name:"inlineCode",components:t,parentName:"p"},"worker")," service accounts (both for Google project and for Kubernetes cluster), and enable required APIs. These accounts are used to simplify authentication (in accordance with the latest Google recommendations), using Workload Identity. This allows to configure access to Google resources through Kubernetes service account ",o.a.createElement(l.MDXTag,{name:"inlineCode",components:t,parentName:"p"},"worker")," (on Kubernetes side). Such setup eliminates the need to manage Kubernetes secrets, greatly simplifying overall configuration. To automate the process completely, change to ",o.a.createElement(l.MDXTag,{name:"inlineCode",components:t,parentName:"p"},"k8s")," subdirectory and apply Terraform configuration:"),o.a.createElement(l.MDXTag,{name:"pre",components:t},o.a.createElement(l.MDXTag,{name:"code",components:t,parentName:"pre",props:{className:"language-sh"}},"cd k8s\nterraform init\nterraform apply\n")),o.a.createElement(l.MDXTag,{name:"p",components:t},"That is it for infrastructure! Later, if you wish to add new permissions, you may achieve this through Google service account ",o.a.createElement(l.MDXTag,{name:"inlineCode",components:t,parentName:"p"},"worker"),". For example, to work with ",o.a.createElement(l.MDXTag,{name:"em",components:t,parentName:"p"},"Google Cloud Storage"),", we added a new ",o.a.createElement(l.MDXTag,{name:"inlineCode",components:t,parentName:"p"},"roles/storage.admin")," role binding and enable storage API:"),o.a.createElement(l.MDXTag,{name:"pre",components:t},o.a.createElement(l.MDXTag,{name:"code",components:t,parentName:"pre",props:{className:"language-sh"}},'resource "google_project_iam_binding" "storage_access" {\n  role    = "roles/storage.admin"\n\n  members = [\n    "serviceAccount:${var.service_account_name}@${var.project_id}.iam.gserviceaccount.com",\n  ]\n}\n\nresource "google_project_service" "storage_json" {\n  project = var.project_id\n  service = "storage-api.googleapis.com"\n}\n')),o.a.createElement(l.MDXTag,{name:"p",components:t},"To list role bindings and to enable services, the following CLI commands could be used:"),o.a.createElement(l.MDXTag,{name:"pre",components:t},o.a.createElement(l.MDXTag,{name:"code",components:t,parentName:"pre",props:{className:"language-sh"}},"# to check policies\ngcloud projects get-iam-policy project_id\n# to check enabled APIs\ngcloud services list\n")),o.a.createElement(l.MDXTag,{name:"h1",components:t},"Next"),o.a.createElement(l.MDXTag,{name:"p",components:t},"The source code and short installation instructions are available on ",o.a.createElement(l.MDXTag,{name:"a",components:t,parentName:"p",props:{href:"https://github.com/act-labs/airflow-gke",title:"Apache Airflow setup on GKE"}},"GitHub"),". After installation, to get started with Airflow and Google Cloud services see my ",o.a.createElement(l.MDXTag,{name:"a",components:t,parentName:"p",props:{href:"/posts/airflow-gke-getting-started/",title:"Getting started with Airflow on GKE"}},"next blog post"),"."))},t}(o.a.Component),p=a(757);function u(e){return o.a.createElement(p.a,e,o.a.createElement(m,e))}a.d(t,"default",function(){return u})},737:function(e,t,a){"use strict";a(46);var n=a(738),o=a(0),r=a.n(o),s=a(2),i=a.n(s),c=a(748),l=a.n(c),m=a(34);function p(e){var t=e.description,a=e.lang,o=e.meta,s=e.keywords,i=e.title;return r.a.createElement(m.b,{query:u,render:function(e){return"string"==typeof s&&(s=s.split(",").map(function(e){return e.trim()})),t=t||e.site.siteMetadata.description,r.a.createElement(l.a,{htmlAttributes:{lang:a},title:i,titleTemplate:"%s | "+e.site.siteMetadata.project,meta:[{name:"description",content:t},{property:"og:title",content:i},{property:"og:description",content:t},{property:"og:type",content:"website"},{name:"twitter:card",content:"summary"},{name:"twitter:creator",content:e.site.siteMetadata.author},{name:"twitter:title",content:i},{name:"twitter:description",content:t}].concat(s?{name:"keywords",content:s.join(", ")}:[]).concat(o)})},data:n})}p.defaultProps={lang:"en",meta:[],keywords:null},p.propTypes={description:i.a.string,lang:i.a.string,meta:i.a.array,keywords:i.a.oneOfType([i.a.string,i.a.arrayOf(i.a.string)]),title:i.a.string.isRequired},t.a=p;var u="304502870"},738:function(e){e.exports={data:{site:{siteMetadata:{project:"ACT blog",description:"React, Ant Design, Gatsby, GraphQl, and other web technologies",author:"Act Labs"}}}}},739:function(e,t,a){"use strict";a.d(t,"a",function(){return l});a(352);var n=a(740),o=a(0),r=a.n(o),s=a(34),i=a(231),c=a.n(i);function l(){return r.a.createElement(s.b,{query:"2369744027",render:function(e){return r.a.createElement(c.a,{fixed:e.logo.childImageSharp.fixed,style:{float:"left"}})},data:n})}},740:function(e){e.exports={data:{logo:{childImageSharp:{fixed:{base64:"data:image/png;base64,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",width:50,height:60,src:"/static/a64620346ac3ce8d4580a3f07039fa3c/8469d/logo.png",srcSet:"/static/a64620346ac3ce8d4580a3f07039fa3c/8469d/logo.png 1x"}}}}}},741:function(e){e.exports={data:{config:{copyright:"Copyright Â© Act Labs",social:[{icon:"facebook",link:"https://www.facebook.com/ACT7LAB"},{icon:"github",link:"https://github.com/act-labs/gatsby-starter-act-blog"}]}}}},742:function(e){e.exports={data:{config:{nav:[{text:"home",slug:null},{text:"posts",slug:"/posts/"},{text:"snippets",slug:"/snippets/"}]}}}},743:function(e,t,a){"use strict";a(6);var n=a(138),o=(a(178),a(31)),r=a.n(o),s=(a(749),a(735),a(736)),i=a.n(s),c=a(741),l=a(0),m=a.n(l),p=a(34),u=i.a.Footer;function d(e){var t=e.social,a=e.copyright,o=t.map(function(e){var t=e.link,a=e.icon;return m.a.createElement(n.a,{key:a,to:t},m.a.createElement(r.a,{type:a,style:{fontSize:"24px",marginLeft:10,color:"rgba(0, 0, 0, 0.65)"}}))});return m.a.createElement(u,{style:{textAlign:"center"}},m.a.createElement("div",null,a,m.a.createElement("div",{style:{float:"right"}},o)))}function g(e){return e.social?m.a.createElement(d,e):m.a.createElement(p.b,{query:"2743462859",render:function(t){var a=t.config,n=a.social,o=a.copyright;return m.a.createElement(d,Object.assign({social:n,copyright:o},e))},data:c})}a(747);var f=a(746),h=a.n(f),y=a(739),w=a(742),b=i.a.Header;function E(e){var t=e.nav;return m.a.createElement(b,{className:"navigation-bar"},m.a.createElement(n.a,{to:"/"},m.a.createElement(y.a,null)),m.a.createElement(h.a,{theme:"dark",mode:"horizontal",defaultSelectedKeys:t.filter(function(e){return e.selected}).map(function(e){return e.text}),style:{lineHeight:"64px"}},t.map(function(e,t){var a=e.slug,o=e.text;return m.a.createElement(h.a.Item,{key:t},m.a.createElement(n.a,{to:a||"/"},o))})))}function v(e){return e.nav?m.a.createElement(E,e):m.a.createElement(p.b,{query:"1250442554",render:function(t){var a=t.config.nav;return m.a.createElement(E,Object.assign({nav:a},e))},data:w})}var k=a(737),T=a(14),D=a.n(T);a(671);a.d(t,"a",function(){return N});var A=i.a.Content,M=i.a.Sider;function X(e){var t=e.style,a=e.children,n=D()(e,["style","children"]);return m.a.createElement(A,Object.assign({style:Object.assign({padding:"5px 24px"},t)},n),a)}function N(e){var t=e.children,a=e.className,n=e.title,o=e.description,r=e.keywords,s=e.style,c=e.layout,l=Object.assign({},C,c),p=l.footer,u=l.fullHeight,d=Object.assign({},u?{height:"100%"}:null,s),f=(a?a+" ":"")+"page-layout";return m.a.createElement(i.a,{className:f,style:d},m.a.createElement(k.a,{title:n,keywords:r,description:o}),m.a.createElement(v,null),t,p?m.a.createElement(g,null):null)}var C={footer:!0};N.Panel=X,N.SideMenuPanel=function(e){var t=e.children,a=e.menu;return m.a.createElement(i.a,{style:{padding:"1em 0",background:"#fff",minHeight:1e3}},m.a.createElement(M,{width:200},a),m.a.createElement(X,null,t))}},745:function(e,t,a){"use strict";a(6);var n=a(138),o=(a(46),a(0)),r=a.n(o),s=a(891),i=a(751),c=a(752),l=a(753),m=a(754),p=a(755),u=a(756);s.a.registerLanguage("javascript",i.a),s.a.registerLanguage("sh",c.a),s.a.registerLanguage("markdown",l.a),s.a.registerLanguage("yaml",m.a),s.a.registerLanguage("dockerfile",p.a);var d=a(1);a.d(t,"a",function(){return f});var g={components:{code:function(e){var t="bash";if(e.className){var a=e.className.split("-");a.length>1&&(t=a[1])}return r.a.createElement(s.a,{language:t,style:u.github},e.children)},a:n.a}};function f(e){var t=Object.assign({},g,e),a=t.components,n=t.children;return r.a.createElement(d.MDXProvider,{components:a},n)}},757:function(e,t,a){"use strict";a.d(t,"a",function(){return c});var n=a(745),o=(a(6),a(743)),r=a(0),s=a.n(r),i=(a(672),o.a.Panel);function c(e){var t=e.children,a=e.pageContext,r=Object.assign({frontmatter:{}},a),c=Object.assign({},{layout:r.layout},r.frontmatter);return s.a.createElement(o.a,c,s.a.createElement(i,{style:{paddingTop:"1em"}},c.title?s.a.createElement("h1",null,c.title):null,s.a.createElement(n.a,null,t)))}}}]);
//# sourceMappingURL=component---src-generated-posts-airflow-gke-js-9229a005ee45a924cc51.js.map